<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Building Benvos • rbenvo</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Building Benvos">
<meta property="og:description" content="rbenvo">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">rbenvo</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.0.4</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/Building_Benvos.html">Building Benvos</a>
    </li>
    <li>
      <a href="../articles/Introduction.html">Getting Started with Benvos</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="Building_Benvos_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Building Benvos</h1>
            
      
      
      <div class="hidden name"><code>Building_Benvos.Rmd</code></div>

    </div>

    
    
<div class="sourceCode" id="cb1"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">rbenvo</span>)</pre></body></html></div>
<div id="motivation" class="section level1">
<h1 class="hasAnchor">
<a href="#motivation" class="anchor"></a>Motivation</h1>
<p>In the <a href="https://apeterson91.github.io/rbenvo/articles/Introduction.html">Introductory vignette</a>, the <code>benvo</code> class was introduced using subject and built environment feature (BEF) data that had already been joined and calculated. An alternative way to construct <code>benvo</code>’s (as of v1.0.0) is to calculate the distances and times from the Subject and BEF data iteratively. This requires that the data be stored either as an <code>sf</code> object for distance calculation and/or there be date/time information. In this vignette, I’ll demonstrate how to program this iterative construction beginning with an example where there is spatial data, covering temporal data subsequently.</p>
<div id="spatial-data" class="section level2">
<h2 class="hasAnchor">
<a href="#spatial-data" class="anchor"></a>Spatial Data</h2>
<p>We’ll begin with a look at two datasets composed of subject and BEF data respectively that can be procured publicly via the California Department of Education and the <a href="https://github.com/ropensci/osmdata"><code>osmdata</code> package</a> respectively (See <a href="https://github.com/apeterson91/rbenvo/blob/master/data-raw/CA.R">here</a> for how I downloaded these data). The former dataset contains information on 5th, 7th and 9th graders’ obesity at schools through the state of California, though we’ll focus on those schools and restaurants in Los Angeles for ease of exposition.</p>
<div class="sourceCode" id="cb2"><html><body><pre class="r"><span class="no">LA_schools</span>
<span class="co">#&gt; # A tibble: 698 x 9</span>
<span class="co">#&gt;    cdscode Charter Grade     N Percent NoStud_Overweig… NoStud_NotOverw…</span>
<span class="co">#&gt;    &lt;chr&gt;   &lt;fct&gt;   &lt;fct&gt; &lt;dbl&gt;   &lt;dbl&gt;            &lt;dbl&gt;            &lt;dbl&gt;</span>
<span class="co">#&gt;  1 141014… Charter 9        19    47.4                9               10</span>
<span class="co">#&gt;  2 191019… Charter 7        92    35.9               33               59</span>
<span class="co">#&gt;  3 191019… Charter 9        44    52.3               23               21</span>
<span class="co">#&gt;  4 191019… Tradit… 9        99    19.2               19               80</span>
<span class="co">#&gt;  5 196473… Charter 5        45    33.3               15               30</span>
<span class="co">#&gt;  6 196473… Charter 5       101    59.4               60               41</span>
<span class="co">#&gt;  7 196473… Charter 7       127    59.4               75               52</span>
<span class="co">#&gt;  8 196473… Charter 5       101    46.5               47               54</span>
<span class="co">#&gt;  9 196473… Charter 7       127    46.5               59               68</span>
<span class="co">#&gt; 10 196473… Charter 5        65    46.2               30               35</span>
<span class="co">#&gt; # … with 688 more rows, and 2 more variables: Latitude &lt;dbl&gt;, Longitude &lt;dbl&gt;</span></pre></body></html></div>
<p>The latter dataset contains businesses labeled as “Fast Food” in the Los Angeles Area, by users of <a href="https://www.openstreetmap.org/">openstreetmap</a>, a crowd-sourcing map tool which allows users to document different areas of their environment.</p>
<div class="sourceCode" id="cb3"><html><body><pre class="r"><span class="no">LA_FF</span>
<span class="co">#&gt; # A tibble: 6,621 x 4</span>
<span class="co">#&gt;    Name               osm_id    Latitude Longitude</span>
<span class="co">#&gt;    &lt;chr&gt;              &lt;chr&gt;        &lt;dbl&gt;     &lt;dbl&gt;</span>
<span class="co">#&gt;  1 &lt;NA&gt;               60713740     -118.      34.1</span>
<span class="co">#&gt;  2 Yoshinoya          72448982     -118.      34.1</span>
<span class="co">#&gt;  3 Jack in the Box    72448995     -118.      34.1</span>
<span class="co">#&gt;  4 Baja Fresh         344723703    -118.      34.2</span>
<span class="co">#&gt;  5 Jersey Mike's Subs 344723888    -118.      34.2</span>
<span class="co">#&gt;  6 Taco Bell          344727689    -118.      34.2</span>
<span class="co">#&gt;  7 Baja Fresh         349339405    -118.      34.1</span>
<span class="co">#&gt;  8 Chipotle           349340479    -118.      34.1</span>
<span class="co">#&gt;  9 Subway             354910320    -118.      34.3</span>
<span class="co">#&gt; 10 &lt;NA&gt;               358019457    -118.      34.2</span>
<span class="co">#&gt; # … with 6,611 more rows</span></pre></body></html></div>
<p>In order to prepare these data for use in a <code>benvo</code>, we’ll convert them to <code>sf</code> objects using the <code>sf::st:as_sf()</code> function as follows. Note that while these data are <code>sfc_POINT</code> objects, they could be any <code>sf</code> object, provided they have a location and a measure of distance can be calculated between the subject and bef data frames.</p>
<div class="sourceCode" id="cb4"><html><body><pre class="r"><span class="no">LA_schools</span> <span class="kw">&lt;-</span> <span class="kw pkg">sf</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/sf/man/st_as_sf.html">st_as_sf</a></span>(<span class="no">LA_schools</span>,<span class="kw">coords</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"Longitude"</span>,<span class="st">"Latitude"</span>),<span class="kw">crs</span><span class="kw">=</span><span class="fl">4326</span>)</pre></body></html></div>
<p>To create a benvo, we use the same <code><a href="../reference/benvo.html">benvo()</a></code> function as used with pre-calculated data, but we now specify the unique subject id so the object can correctly link future data tables.</p>
<div class="sourceCode" id="cb5"><html><body><pre class="r"><span class="fu"><a href="../reference/benvo.html">benvo</a></span>(<span class="no">LA_schools</span>,<span class="kw">by</span><span class="kw">=</span><span class="st">'cdscode'</span>)
<span class="co">#&gt; Active df:  subject</span>
<span class="co">#&gt; Simple feature collection with 698 features and 7 fields</span>
<span class="co">#&gt; geometry type:  POINT</span>
<span class="co">#&gt; dimension:      XY</span>
<span class="co">#&gt; bbox:           xmin: -118.4958 ymin: 33.90556 xmax: -118.136 ymax: 34.29046</span>
<span class="co">#&gt; geographic CRS: WGS 84</span>
<span class="co">#&gt; # A tibble: 698 x 8</span>
<span class="co">#&gt;    cdscode Charter Grade     N Percent NoStud_Overweig… NoStud_NotOverw…</span>
<span class="co">#&gt;  * &lt;chr&gt;   &lt;fct&gt;   &lt;fct&gt; &lt;dbl&gt;   &lt;dbl&gt;            &lt;dbl&gt;            &lt;dbl&gt;</span>
<span class="co">#&gt;  1 141014… Charter 9        19    47.4                9               10</span>
<span class="co">#&gt;  2 191019… Charter 7        92    35.9               33               59</span>
<span class="co">#&gt;  3 191019… Charter 9        44    52.3               23               21</span>
<span class="co">#&gt;  4 191019… Tradit… 9        99    19.2               19               80</span>
<span class="co">#&gt;  5 196473… Charter 5        45    33.3               15               30</span>
<span class="co">#&gt;  6 196473… Charter 5       101    59.4               60               41</span>
<span class="co">#&gt;  7 196473… Charter 7       127    59.4               75               52</span>
<span class="co">#&gt;  8 196473… Charter 5       101    46.5               47               54</span>
<span class="co">#&gt;  9 196473… Charter 7       127    46.5               59               68</span>
<span class="co">#&gt; 10 196473… Charter 5        65    46.2               30               35</span>
<span class="co">#&gt; # … with 688 more rows, and 1 more variable: geometry &lt;POINT [°]&gt;</span></pre></body></html></div>
<p>In order to construct the new table of subj-BEF distances and incorporate the bef table into the relational data structure of the <code>benvo</code>, the appropriately named <code><a href="../reference/add_BEF.html">add_BEF()</a></code> function works much like it sounds. We can then <code>activate</code> the restaurant table in order to look at the distances.</p>
<div class="sourceCode" id="cb6"><html><body><pre class="r"><span class="fu"><a href="../reference/benvo.html">benvo</a></span>(<span class="no">LA_schools</span>,<span class="kw">by</span><span class="kw">=</span><span class="st">'cdscode'</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="../reference/add_BEF.html">add_BEF</a></span>(<span class="no">FFR</span>,<span class="kw">bef_id</span> <span class="kw">=</span> <span class="st">'osm_id'</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="../reference/activate.html">activate</a></span>(<span class="no">FFR</span>) <span class="kw">-&gt;</span> <span class="no">bdf</span>
<span class="co">#&gt; Linking to GEOS 3.8.1, GDAL 3.1.1, PROJ 6.3.1</span>
<span class="no">bdf</span>
<span class="co">#&gt; Active df:  FFR</span>
<span class="co">#&gt; # A tibble: 4,621,458 x 3</span>
<span class="co">#&gt;    cdscode        osm_id    Distance</span>
<span class="co">#&gt;    &lt;chr&gt;          &lt;chr&gt;          [m]</span>
<span class="co">#&gt;  1 14101400128454 60713740 19717.047</span>
<span class="co">#&gt;  2 19101990134361 60713740 17167.510</span>
<span class="co">#&gt;  3 19101990135582 60713740 17606.308</span>
<span class="co">#&gt;  4 19101991933399 60713740  5907.847</span>
<span class="co">#&gt;  5 19647330100289 60713740  9887.820</span>
<span class="co">#&gt;  6 19647330100669 60713740 18522.629</span>
<span class="co">#&gt;  7 19647330100669 60713740 18522.629</span>
<span class="co">#&gt;  8 19647330100669 60713740 18522.629</span>
<span class="co">#&gt;  9 19647330100669 60713740 18522.629</span>
<span class="co">#&gt; 10 19647330100743 60713740 14184.749</span>
<span class="co">#&gt; # … with 4,621,448 more rows</span></pre></body></html></div>
<p>As can be seen here, the <code><a href="../reference/add_BEF.html">add_BEF()</a></code> function uses the <code><a href="https://rdrr.io/pkg/sf/man/geos_measures.html">sf::st_distance</a></code> function by default which returns a distance (great circle distance in this case) according to the coordinate reference system set for the <code>sf</code> objects. In this case the units are meters , but we can convert them to km and remove those pairings that are greater than 10km using the <code>dplyr</code> verbs adapted to function on whatever table is currently active in the <code>benvo</code>. Since we have repeat measurements for each school we have multiple distances for each school when we only need 1, so we’ll use a combination of <a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a> and <a href="https://dplyr.tidyverse.org/reference/distinct_all.html?q=distinct">distinct</a> to remove the duplicate and extraneous (&gt;10 km) distances:</p>
<div class="sourceCode" id="cb7"><html><body><pre class="r"><span class="no">bdf</span> <span class="kw">&lt;-</span> <span class="no">bdf</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="kw">Distance</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="no">Distance</span>/<span class="fl">1E3</span>)) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(<span class="no">Distance</span><span class="kw">&lt;=</span><span class="fl">10</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html">distinct</a></span>(<span class="no">cdscode</span>,<span class="no">osm_id</span>,<span class="no">Distance</span>)
<span class="no">bdf</span>
<span class="co">#&gt; Active df:  FFR</span>
<span class="co">#&gt; # A tibble: 489,034 x 3</span>
<span class="co">#&gt;    cdscode        osm_id   Distance</span>
<span class="co">#&gt;    &lt;chr&gt;          &lt;chr&gt;       &lt;dbl&gt;</span>
<span class="co">#&gt;  1 19101991933399 60713740     5.91</span>
<span class="co">#&gt;  2 19647330100289 60713740     9.89</span>
<span class="co">#&gt;  3 19647330100867 60713740     9.55</span>
<span class="co">#&gt;  4 19647330101683 60713740     5.48</span>
<span class="co">#&gt;  5 19647330102426 60713740     6.37</span>
<span class="co">#&gt;  6 19647330106435 60713740     9.36</span>
<span class="co">#&gt;  7 19647330108886 60713740     7.89</span>
<span class="co">#&gt;  8 19647330109439 60713740     3.22</span>
<span class="co">#&gt;  9 19647330110304 60713740     8.82</span>
<span class="co">#&gt; 10 19647330111658 60713740     5.91</span>
<span class="co">#&gt; # … with 489,024 more rows</span></pre></body></html></div>
<p>While we could get a sense of the distribution of distances using the <code><a href="../reference/plot_pointrange.html">plot_pointrange()</a></code> function as illustrated in the <a href="https://apeterson91.github.io/rbenvo/articles/Introduction.html">Introductory vignette</a>, instead, here we’ll use the <code><a href="../reference/plot_map.html">plot_map()</a></code> function, via the <code>plot</code> which will produce a ggplot object of the spatial objects distinguished as BEF or subject by color on a map defined by the boundaries of the combined <code>sf</code> objects, using <code>ggmap</code> to request the underlying stamen map.</p>
<div class="sourceCode" id="cb8"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span>(<span class="no">bdf</span>,<span class="st">'map'</span>) + <span class="kw pkg">ggplot2</span><span class="kw ns">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span>() + <span class="kw pkg">ggplot2</span><span class="kw ns">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_void</a></span>()
<span class="co">#&gt; Source : http://tile.stamen.com/terrain/10/174/407.png</span>
<span class="co">#&gt; Source : http://tile.stamen.com/terrain/10/175/407.png</span>
<span class="co">#&gt; Source : http://tile.stamen.com/terrain/10/174/408.png</span>
<span class="co">#&gt; Source : http://tile.stamen.com/terrain/10/175/408.png</span>
<span class="co">#&gt; Source : http://tile.stamen.com/terrain/10/174/409.png</span>
<span class="co">#&gt; Source : http://tile.stamen.com/terrain/10/175/409.png</span>
<span class="co">#&gt; Coordinate system already present. Adding new coordinate system, which will replace the existing one.</span></pre></body></html></div>
<p><img src="Building_Benvos_files/figure-html/unnamed-chunk-5-1.png" width="700"> For more on how these data might be modeled, check out the <a href="https://apeterson91.github.io/rsstap/articles/Introduction.html"><code>rsstap</code></a> or <a href="https://apeterson91.github.io/bentobox/articles/Introduction.html"><code>bentobox</code></a> packages.</p>
<p>Having looked at how <code>benvo</code>’s handle spatial data, we’ll now turn to temporal data.</p>
</div>
<div id="temporal-data" class="section level2">
<h2 class="hasAnchor">
<a href="#temporal-data" class="anchor"></a>Temporal Data</h2>
<p>Similar to how one may have spatial data available for built environment features and subjects it’s also possible to have temporal data, describing the time a subject spent at a specific location. Depending on the analysis spatial and temporal structures can both be quite complex, as before we’ll illustrate how temporal data can be incorporated into a benvo with cross-sectional temporal data where each subject is only associated with one time point. More complex temporal data, where there are multiple time points associated with each subject, as in the case of longitudinal data, will be incorporated in a future release.</p>
<div id="temporal-data-simulation" class="section level3">
<h3 class="hasAnchor">
<a href="#temporal-data-simulation" class="anchor"></a>Temporal Data Simulation</h3>
<p>We’ll begin by simulating dates for the Los Angeles Schools that have fifth graders and Fast Food Restaurant data. We’ll set all schools to start sometime in the fall, and have the business arbitrarily open and close sometime after 2015.</p>
<div class="sourceCode" id="cb9"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(<span class="fl">342431</span>)
<span class="no">LA_schools_five</span>  <span class="kw">&lt;-</span>  <span class="no">LA_schools</span> <span class="kw">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(<span class="no">Grade</span><span class="kw">==</span><span class="fl">5</span>)
<span class="no">origin</span> <span class="kw">&lt;-</span> <span class="kw pkg">lubridate</span><span class="kw ns">::</span><span class="fu"><a href="http://lubridate.tidyverse.org/reference/as_date.html">as_date</a></span>(<span class="st">"2018-08-01"</span>)
<span class="no">school_start</span> <span class="kw">&lt;-</span> <span class="no">origin</span>+<span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span>(<span class="fl">1</span>:<span class="fl">120</span>,<span class="kw">size</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(<span class="no">LA_schools_five</span>),<span class="kw">replace</span> <span class="kw">=</span> <span class="fl">TRUE</span>)
<span class="no">measure_date</span> <span class="kw">&lt;-</span> <span class="kw pkg">lubridate</span><span class="kw ns">::</span><span class="fu"><a href="http://lubridate.tidyverse.org/reference/as_date.html">as_date</a></span>(<span class="st">"2019-05-01"</span>)
<span class="no">close_date</span> <span class="kw">&lt;-</span> <span class="no">measure_date</span>
<span class="no">business_start_date</span> <span class="kw">&lt;-</span> <span class="no">origin</span> + <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span>(-<span class="fl">786</span>:<span class="fl">786</span>,<span class="kw">size</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(<span class="no">LA_FF</span>),<span class="kw">replace</span> <span class="kw">=</span> <span class="fl">TRUE</span>)
<span class="no">business_close_date</span> <span class="kw">&lt;-</span> <span class="no">business_start_date</span> + <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span>((<span class="kw pkg">lubridate</span><span class="kw ns">::</span><span class="fu"><a href="http://lubridate.tidyverse.org/reference/now.html">today</a></span>()-<span class="no">business_start_date</span>),<span class="kw">function</span>(<span class="no">x</span>) <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span>(<span class="fl">1</span>:<span class="no">x</span>,<span class="fl">1</span>))
<span class="no">FFR</span> <span class="kw">&lt;-</span> <span class="no">LA_FF</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="kw">open</span><span class="kw">=</span><span class="no">business_start_date</span>,<span class="kw">close</span><span class="kw">=</span><span class="no">business_close_date</span>)
<span class="no">schools</span> <span class="kw">&lt;-</span> <span class="no">LA_schools_five</span> <span class="kw">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="kw">open</span><span class="kw">=</span><span class="no">school_start</span>,<span class="kw">measure</span><span class="kw">=</span><span class="no">measure_date</span>,<span class="kw">close</span><span class="kw">=</span><span class="no">close_date</span>)</pre></body></html></div>
<p>We create the benvo using the same function as before, but now including the optional arguments that specify the start,measurement, and stop date columns for each subject observation which are each vectors of <code><a href="http://lubridate.tidyverse.org/reference/date_utils.html">lubridate::Date</a></code> objects. These must be named similarly in any subsequent BEF table that is then added, as in the FFR example here. The <code><a href="../reference/benvo.html">benvo()</a></code> function uses these date columns to then construct the time exposed, labeled as Time and exposure lag (time between the end of the exposure period and the current measurement date)</p>
<div class="sourceCode" id="cb10"><html><body><pre class="r"><span class="no">bdf</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/benvo.html">benvo</a></span>(<span class="no">schools</span>,
      <span class="kw">start_date_col</span><span class="kw">=</span><span class="st">"open"</span>,
      <span class="kw">measurement_date</span><span class="kw">=</span><span class="st">"measure"</span>,
      <span class="kw">stop_date_col</span><span class="kw">=</span><span class="st">"close"</span>,<span class="kw">by</span><span class="kw">=</span><span class="st">'cdscode'</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="../reference/add_BEF.html">add_BEF</a></span>(<span class="no">FFR</span>,<span class="kw">bef_id</span> <span class="kw">=</span> <span class="st">'osm_id'</span>)</pre></body></html></div>
<p>We can look at the constructed times, by activating the FFR table.</p>
<div class="sourceCode" id="cb11"><html><body><pre class="r"><span class="no">bdf</span> <span class="kw">%&gt;%</span> <span class="fu"><a href="../reference/activate.html">activate</a></span>(<span class="no">FFR</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>(-<span class="no">open</span>,-<span class="no">close</span>) <span class="co">## for better display</span>
<span class="co">#&gt; Active df:  FFR</span>
<span class="co">#&gt; # A tibble: 1,168,497 x 7</span>
<span class="co">#&gt;    cdscode       measure    open_FFR   close_FFR  osm_id    Time    exposure_lag</span>
<span class="co">#&gt;    &lt;chr&gt;         &lt;date&gt;     &lt;date&gt;     &lt;date&gt;     &lt;chr&gt;     &lt;drtn&gt;  &lt;drtn&gt;      </span>
<span class="co">#&gt;  1 196473301002… 2019-05-01 2016-06-06 2019-03-03 42979757…  98 da…  59 days    </span>
<span class="co">#&gt;  2 196473301002… 2019-05-01 2016-06-06 2020-04-22 41070726… 157 da…   0 days    </span>
<span class="co">#&gt;  3 196473301002… 2019-05-01 2016-06-07 2020-04-09 66588233… 157 da…   0 days    </span>
<span class="co">#&gt;  4 196473301002… 2019-05-01 2016-06-09 2019-01-17 42448677…  53 da… 104 days    </span>
<span class="co">#&gt;  5 196473301002… 2019-05-01 2016-06-09 2019-05-15 41026121… 157 da…   0 days    </span>
<span class="co">#&gt;  6 196473301002… 2019-05-01 2016-06-09 2020-07-28 42256375… 157 da…   0 days    </span>
<span class="co">#&gt;  7 196473301002… 2019-05-01 2016-06-10 2019-03-10 46601780… 105 da…  52 days    </span>
<span class="co">#&gt;  8 196473301002… 2019-05-01 2016-06-10 2019-08-26 43027016… 157 da…   0 days    </span>
<span class="co">#&gt;  9 196473301002… 2019-05-01 2016-06-10 2019-09-03 18732152… 157 da…   0 days    </span>
<span class="co">#&gt; 10 196473301002… 2019-05-01 2016-06-10 2020-08-07 46589894… 157 da…   0 days    </span>
<span class="co">#&gt; # … with 1,168,487 more rows</span></pre></body></html></div>
<p>Similar to how the distances were calculated in specific units from the <code><a href="https://rdrr.io/pkg/sf/man/geos_measures.html">sf::st_distance()</a></code> function, the <code>lubridate</code> function calculates differences in times according to the granularity of the data. Here since we have information available in days, we calculate differences in units of days. These can be altered according to user preference, as before using the dplyr verb functions and converting times according to the functions in the <a href="https://lubridate.tidyverse.org/reference/lubridate-package.html">lubridate package</a>.</p>
<p>To finish off this section we’ll highlight a timeline plot that is currently available for visualizing the temporal exposure for subjects. The plot below shows when the different schools opened and closed. Since we’re showing all schools were closed and measured at the same time, we have a uniform line at the right side. This is just a feature of how we constructed the data, but it could be different. As the starting times show variability on the left hand side of the plot, it is not hard to imagine a setting in which there’d be similar variability for closing and measure times.</p>
<div class="sourceCode" id="cb12"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span>(<span class="no">bdf</span>,<span class="st">'time'</span>)</pre></body></html></div>
<p><img src="Building_Benvos_files/figure-html/timeline-1.png" width="700"></p>
</div>
</div>
<div id="summary" class="section level2">
<h2 class="hasAnchor">
<a href="#summary" class="anchor"></a>Summary</h2>
<p>This vignette demonstrated how to construct <code>benvo</code>s iteratively using raw location and temporal data of subject and BEFs as well as how to manipulate and display the constructed data. We also showed a quick example highlighting how these objects are used in other packages, like <code>rsstap</code>, to understand how BEF’s may impact human health in a sample analysis using data that can be accessed publicly from the internet. It is my hope that this package makes working with the very particular relational structure of built environment data, easier and more accessible for those interested in studying it.</p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Adam Peterson.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
